var freeaps_determineBasal;(()=>{var e={5546:(e,a,r)=>{var t=r(6880);function o(e,a){a||(a=0);var r=Math.pow(10,a);return Math.round(e*r)/r}function i(e,a){return"mmol/L"===a.out_units?o(e/18,1):Math.round(e)}var n="",s="",l="",d="",m="",u="",c="",g="",b="";function p(e,a){var r=[2,7,12,16,20,50,60,80,90,100,110,150,180,200],t=[0,0,.4,.7,.7,-.5,-.5,-.3,-.2,0,0,.5,.7,.7],o=r.length-1,i=r[0],n=t[0],s=r[o],l=t[o],d=1,m=1,u=1,c=i;if(i>e)d=(m=n)+((l=t[1])-m)/((s=r[1])-(u=i))*(e-u);else if(s<e)d=(m=n=t[o-1])+(l-m)/(s-(u=i=r[o-1]))*(e-u);else for(var g=0;g<=o;g++){if(n=t[g],(i=r[g])==e){d=n;break}if(i>e){d=m+(n-m)/(i-(u=c))*(e-u);break}m=n,c=i}return d*=e>100?a.higher_ISFrange_weight:e>40?a.lower_ISFrange_weight:a.delta_ISFrange_weight}function f(e,a,r){if(void 0===e.smb_delivery_ratio_bg_range||0===e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var t=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(a<=r)return console.error("SMB delivery ratio limited by minimum value "+t),t;var i=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(a>=r+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+i),i;var n=t+(i-t)*(a-r)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(n,2)),n}e.exports=function(e,a,r,v,h,_,B,M,x,S){var y={},C=new Date;if(S&&(C=S),void 0===v||void 0===v.current_basal)return y.error="Error: could not get current basal rate",y;var I=t(v.current_basal,v),F=I,G=new Date;S&&(G=S);var w,O=new Date(e.date),R=o((G-O)/60/1e3,1),A=e.glucose,T=e.noise;w=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var D=Math.min(e.delta,e.short_avgdelta),U=Math.min(e.short_avgdelta,e.long_avgdelta),j=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(A<=10||38===A||T>=3)&&(y.reason="CGM is calibrating, in ??? state, or noise is high");if(A>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&("fakecgm"==e.device?(console.error("CGM data is unchanged ("+i(A,v)+"+"+i(e.delta,v)+") for 5m w/ "+i(e.short_avgdelta,v)+" mg/dL ~15m change & "+i(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")):!0),R>12||R<-5?y.reason="If current system time "+G+" is correct, then BG data is too old. The last BG data was read "+R+"m ago at "+O:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?y.reason="CGM was just calibrated":y.reason="CGM data is unchanged ("+i(A,v)+"+"+i(e.delta,v)+") for 5m w/ "+i(e.short_avgdelta,v)+" mg/dL ~15m change & "+i(e.long_avgdelta,v)+" mg/dL ~45m change"),A<=10||38===A||T>=3||R>12||R<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return a.rate>=F?(y.reason+=". Canceling high temp basal of "+a.rate,y.deliverAt=C,y.temp="absolute",y.duration=0,y.rate=0,y):0===a.rate&&a.duration>30?(y.reason+=". Shortening "+a.duration+"m long zero temp to 30m. ",y.deliverAt=C,y.temp="absolute",y.duration=30,y.rate=0,y):(y.reason+=". Temp "+a.rate+" <= current basal "+F+"U/hr; doing nothing. ",y);var P,q,E,W=v.max_iob;if(void 0!==v.min_bg&&(q=v.min_bg),void 0!==v.max_bg&&(E=v.max_bg),void 0===v.min_bg||void 0===v.max_bg)return y.error="Error: could not determine target_bg. ",y;P=(v.min_bg+v.max_bg)/2;var k=v.exercise_mode||v.high_temptarget_raises_sensitivity,z=100;if(v.half_basal_exercise_target)var L=v.half_basal_exercise_target;else L=160;if(k&&v.temptargetSet&&P>z||v.low_temptarget_lowers_sensitivity&&v.temptargetSet&&P<z){var N=L-z;N+P-z>0?(sensitivityRatio=N/(N+P-z),sensitivityRatio=Math.min(sensitivityRatio,v.autosens_max),sensitivityRatio=o(sensitivityRatio,2)):sensitivityRatio=v.autosens_max,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+P+"; ")}else void 0!==h&&h&&(sensitivityRatio=h.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(F=v.current_basal*sensitivityRatio,(F=t(F,v))!==I?process.stderr.write("Adjusting basal from "+I+" to "+F+"; "):process.stderr.write("Basal unchanged: "+F+"; ")),v.temptargetSet);else if(void 0!==h&&h&&(v.sensitivity_raises_target&&h.ratio<1||v.resistance_lowers_target&&h.ratio>1)){q=o((q-60)/h.ratio)+60,E=o((E-60)/h.ratio)+60;var Z=o((P-60)/h.ratio)+60;P===(Z=Math.max(80,Z))?process.stderr.write("target_bg unchanged: "+Z+"; "):process.stderr.write("target_bg from "+P+" to "+Z+"; "),P=Z}if(e.noise>=2){var $=Math.max(1.1,v.noisyCGMTargetMultiplier),H=(Math.min(250,v.maxRaw),o(Math.min(200,q*$))),J=o(Math.min(200,P*$)),K=o(Math.min(200,E*$));process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+P+" to "+J+"; "),q=H,P=J,E=K}var Q=q-.5*(q-40),V=o(v.sens,1),X=v.sens;if(void 0!==h&&h&&((X=o(X=v.sens/sensitivityRatio,1))!==V?process.stderr.write("ISF from "+i(V,v)+" to "+i(X,v)):process.stderr.write("ISF unchanged: "+i(X,v)),n+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+i(V,v)+"→"+i(X,v)),console.error("CR:"+v.carb_ratio),X=function(e,a,r,t,v,h,_,B){if(!r.use_autoisf)return console.error("autoISF disabled in Preferences"),e;var M=t.autoISF_duration,x=t.autoISF_average,S=t.dura_p,y=t.delta_pl,C=t.delta_pn,I=t.r_squ,F=t.bg_acceleration,G=t.parabola_fit_a0,w=t.parabola_fit_a1,O=t.parabola_fit_a2,R=t.pp_debug;u+="BG-accel: "+o(F,3)+", PF-minutes: "+S+", PF-corr: "+o(I,3)+", PF-nextDelta: "+i(C,r)+", PF-lastDelta: "+i(y,r)+", regular Delta: "+i(t.delta,r),console.error(R+u+" , Weights Accel/Brake: "+r.bgAccel_ISF_weight+" / "+r.bgBrake_ISF_weight);var A=r.autoisf_max,T=!1;if(v.mealCOB>0&&!r.enableautoisf_with_COB)console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1));else{var D=1,U=1,j=a+10-x,P=1;if(r.enable_BG_acceleration){var q=F,E=-w/2/O*5,W=o(G-E*E/25*O,1);(E=o(E,1))<0&&q<0?(b="saw max of "+i(W,r)+", about "+-E+" min ago",console.error("Parabolic fit "+b)):E<0&&q>0?(b="saw min of "+i(W,r)+", about "+-E+" min ago",console.error("Parabolic fit "+b)):E>0&&q<0?(b="predicts max of "+i(W,r)+", in about "+E+"min",console.error("Parabolic fit "+b)):E>0&&q>0&&(b="predicts min of "+i(W,r)+", in about "+E+" min",console.error("Parabolic fit "+b));var k=I;if(k<.9)b="by-passed accel_ISF, as correlation "+o(k,3)+" is too low",console.error("Parabolic fit "+b),c+=", Parabolic Fit, "+b;else{c+=", Parabolic Fit, "+b+", regΔ: "+i(t.delta,r)+", lastΔ: "+i(y,r)+", nextΔ: "+i(C,r)+", Corr "+o(I,3)+", BG-Accel: "+o(F,2);var z=10*(k-.9),L=1;if(t.glucose<r.target_bg&&q>1&&(L=.5),q<0)var N=r.bgBrake_ISF_weight;else N=r.bgAccel_ISF_weight;P=1+q*L*N*z,console.error("Original result for acce_ISF: "+o(P,2)),1!=P&&(T=!0),A<P?console.error("acce_ISF adaptation "+o(P,2)+" limited by autoisf_max = "+A):r.autoisf_min>P?(console.error("acce_ISF adaptation "+o(P,2)+" limited by autoisf_min = "+r.autoisf_min),P=r.autoisf_min):console.error("acce_ISF adaptation is "+o(P,2)),c+=", accel. Ratio: "+o(P,2)}}else console.error("autoISF BG accelertion adaption disabled in Preferences");var Z=f(r,t.glucose,a);n+=", SMB Delivery Ratio:, "+o(Z,2);var $=1+p(100-j,r);if(1!=$&&(s=", bg-ISF Ratio: "+o($,2)),A<$&&(g="bg_ISF adaptation "+o($,2)+", limited by autoisf_max "+A,console.error(g),s=", ltd. bg-ISF Ratio: "+A),$<1)return P>1&&(g="bg_ISF adaptation lifted to "+o($*=P,2)+", as bg accelerates already",console.error(g)),$<r.autoisf_min&&(g="bg_ISF adaptation "+o($,2)+" limited by autoisf_min "+r.autoisf_min,console.error(g),s=", ltd. bg-ISF Ratio: "+r.autoisf_min),e=Math.min(720,o(r.sens/Math.max(r.autoisf_min,$),1)),console.error("early Return autoISF:  "+i(e,r)),e;$>1&&(T=!0);var H=t.delta;j>0?console.error("delta_ISF adaptation by-passed as average glucose < "+i(a+10,r)):t.short_avgdelta<0?console.error("delta_ISF adaptation by-passed as no rise or too short lived"):r.enableppisf_always||r.postmeal_ISF_duration>=(h-v.lastCarbTime)/1e3/3600?1!=(D=1+Math.max(0,H*r.postmeal_ISF_weight))&&(T=!0,A<D?(console.error("pp_ISF adaptation"+D+"limited by autoisf_max"+A),d=", pp-ISF Ratio: "+A):(console.error("pp_ISF adaptation is"+D),d=", pp-ISF Ratio: "+o(D,2))):(U=p(H,r),j>-20&&(U*=.5),1!=(U=1+U)&&(T=!0,A<U?(console.error("delta_ISF adaptation "+U+" limited by autoisf_max "+A),m="regΔ-ISF Ratio: "+A):(console.error("delta_ISF adaptation is "+U),m=", Δ-ISF Ratio: "+o(U,2))))}var J=1,K=r.autoisf_hourlychange;v.mealCOB>0&&!r.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)):M<10?console.error("dura_ISF by-passed; BG is only "+M+"m at level "+x):x<=a?console.error("dura_ISF by-passed; avg. glucose "+x+" below target "+i(a,r)):(J+=M/60*(K/a)*(x-a),T=!0,console.error("dura_ISF reports ISF "+i(e,r)+" did not do it for "+M+"m; go more aggressive by "+o(J,2)),l=", dura-ISF Ratio: "+o(J,2),A<J&&(console.error("dura_ISF adaptation "+o(J,2)+" limited by autoisf_max "+A),l=", dura-ISF Ratio: "+A));if(T){var Q=Math.max(Math.min(A,Math.max(J,$,U,P,D)),B);P<1&&Q>=1&&(console.error("strongest ISF factor "+o(Q,2)+" weakened to "+o(Q*P,2)+" as bg decelerates already"),Q*=P),e=o(r.sens/Q,1),n+=", autoISF, Duration: "+M+", Avg: "+i(x,r)+s+d+m+l+", Ratio: "+o(Q,2)+", ISF: "+i(e,r)+c}return console.error("Inside autoISF result "+i(e,r)),e}(X,P,v,e,_,S,0,sensitivityRatio),void 0===r)return y.error="Error: iob_data undefined. ",y;var Y,ee=r;if(r.length,r.length>1&&(r=ee[0]),void 0===r.activity||void 0===r.iob)return y.error="Error: iob_data missing some property. ",y;var ae=((Y=void 0!==r.lastTemp?o((new Date(G).getTime()-r.lastTemp.date)/6e4):0)+a.duration)%30;if(console.error("currenttemp:"+a.rate+" lastTempAge:"+Y+"m, tempModulus:"+ae+"m"),y.temp="absolute",y.deliverAt=C,M&&a&&r.lastTemp&&a.rate!==r.lastTemp.rate&&Y>10&&a.duration)return y.reason="Warning: currenttemp rate "+a.rate+" != lastTemp rate "+r.lastTemp.rate+" from pumphistory; canceling temp",B.setTempBasal(0,0,v,y,a);if(a&&r.lastTemp&&a.duration>0){var re=Y-r.lastTemp.duration;if(re>5&&Y>10)return y.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+re+"m ago; canceling temp",B.setTempBasal(0,0,v,y,a)}var te=o(-r.activity*X*5,2),oe=o(6*(D-te));if(oe<0&&(oe=o(6*(U-te)))<0&&(oe=o(6*(e.long_avgdelta-te))),r.iob>0)var ie=o(A-r.iob*X);else ie=o(A-r.iob*Math.min(X,v.sens));var ne=ie+oe;if(void 0===ne||isNaN(ne))return y.error="Error: could not calculate eventualBG. Sensitivity: "+X+" Deviation: "+oe,y;var se=function(e,a,r){return o(r+(e-a)/24,1)}(P,ne,te);y={temp:"absolute",bg:A,tick:w,eventualBG:ne,insulinReq:0,reservoir:x,deliverAt:C,sensitivityRatio};var le=[],de=[],me=[],ue=[];le.push(A),de.push(A),ue.push(A),me.push(A);var ce=function(e,a,r,t){return a?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&t>100?(console.error("SMB disabled due to high temptarget of",t),!1):!0===r.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(r.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&r.mealCOB?(r.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",r.mealCOB),!0):!0===e.enableSMB_after_carbs&&r.carbs?(r.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&t<100?(r.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",i(t,e)),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(v,M,_,P),ge=v.enableUAM,be=0,pe=0;be=o(D-te,1);var fe=o(D-te,1);csf=X/v.carb_ratio,console.error("profile.sens:"+i(v.sens,v)+", sens:"+i(X,v)+", CSF:"+o(csf,1));var ve=o(30*csf*5/60,1);be>ve&&(console.error("Limiting carb impact from "+be+" to "+ve+"mg/dL/5m (30g/h)"),be=ve);var he=3;sensitivityRatio&&(he/=sensitivityRatio);var _e=he;if(_.carbs){he=Math.max(he,_.mealCOB/20);var Be=o((new Date(G).getTime()-_.lastCarbTime)/6e4),Me=(_.carbs-_.mealCOB)/_.carbs;_e=o(_e=he+1.5*Be/60,1),console.error("Last carbs "+Be+" minutes ago; remainingCATime:"+_e+"hours; "+o(100*Me)+"% carbs absorbed")}var xe=Math.max(0,be/5*60*_e/2)/csf,Se=90,ye=1;v.remainingCarbsCap&&(Se=Math.min(90,v.remainingCarbsCap)),v.remainingCarbsFraction&&(ye=Math.min(1,v.remainingCarbsFraction));var Ce=1-ye,Ie=Math.max(0,_.mealCOB-xe-_.carbs*Ce),Fe=(Ie=Math.min(Se,Ie))*csf*5/60/(_e/2),Ge=o(_.slopeFromMaxDeviation,2),we=o(_.slopeFromMinDeviation,2),Oe=Math.min(Ge,-we/3),Re=0;0===be?pe=0:!0===v.floating_carbs?(pe=Math.min(60*_e/5/2,Math.max(0,_.carbs*csf/be)),Re=Math.min(60*_e/5/2,Math.max(0,_.mealCOB*csf/be)),_.carbs>0&&(n+=", Floating Carbs:, CID: "+o(pe,1)+", MealCarbs: "+o(_.carbs,1)+", Not Floating:, CID: "+o(Re,1)+", MealCOB: "+o(_.mealCOB,1),console.error("Floating Carbs CID: "+o(pe,1)+" / MealCarbs: "+o(_.carbs,1)+" vs. Not Floating:"+o(Re,1)+" / MealCOB:"+o(_.mealCOB,1)))):pe=Math.min(60*_e/5/2,Math.max(0,_.mealCOB*csf/be)),console.error("Carb Impact:"+be+"mg/dL per 5m; CI Duration:"+o(5*pe/60*2,1)+"hours; remaining CI ("+_e/2+"h peak):",o(Fe,1)+"mg/dL per 5m");var Ae,Te,De,Ue,je,Pe=999,qe=999,Ee=999,We=A,ke=999,ze=999,Le=999,Ne=999,Ze=ne,$e=A,He=A,Je=0,Ke=[],Qe=[];try{ee.forEach((function(e){var a=o(-e.activity*X*5,2),r=o(-e.iobWithZeroTemp.activity*X*5,2),t=be*(1-Math.min(1,de.length/12));Ze=de[de.length-1]+a+t;var i=ue[ue.length-1]+r,n=Math.max(0,Math.max(0,be)*(1-le.length/Math.max(2*pe,1))),s=Math.min(le.length,12*_e-le.length),l=Math.max(0,s/(_e/2*12)*Fe);n+l,Ke.push(o(l,0)),Qe.push(o(n,0)),COBpredBG=le[le.length-1]+a+Math.min(0,t)+n+l;var d=Math.max(0,fe+me.length*Oe),m=Math.max(0,fe*(1-me.length/Math.max(36,1))),u=Math.min(d,m);u>0&&(Je=o(5*(me.length+1)/60,1)),UAMpredBG=me[me.length-1]+a+Math.min(0,t)+u,de.length<48&&de.push(Ze),le.length<48&&le.push(COBpredBG),me.length<48&&me.push(UAMpredBG),ue.length<48&&ue.push(i),COBpredBG<ke&&(ke=o(COBpredBG)),UAMpredBG<ze&&(ze=o(UAMpredBG)),Ze<Le&&(Le=o(Ze)),i<Ne&&(Ne=o(i));de.length>18&&Ze<Pe&&(Pe=o(Ze)),Ze>$e&&($e=Ze),(pe||Fe>0)&&le.length>18&&COBpredBG<qe&&(qe=o(COBpredBG)),(pe||Fe>0)&&COBpredBG>$e&&(He=COBpredBG),ge&&me.length>12&&UAMpredBG<Ee&&(Ee=o(UAMpredBG)),ge&&UAMpredBG>$e&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}_.mealCOB&&(console.error("predCIs (mg/dL/5m):"+Qe.join(" ")),console.error("remainingCIs:      "+Ke.join(" "))),y.predBGs={},de.forEach((function(e,a,r){r[a]=o(Math.min(401,Math.max(39,e)))}));for(var Ve=de.length-1;Ve>12&&de[Ve-1]===de[Ve];Ve--)de.pop();for(y.predBGs.IOB=de,De=o(de[de.length-1]),ue.forEach((function(e,a,r){r[a]=o(Math.min(401,Math.max(39,e)))})),Ve=ue.length-1;Ve>6&&!(ue[Ve-1]>=ue[Ve]||ue[Ve]<=P);Ve--)ue.pop();if(y.predBGs.ZT=ue,o(ue[ue.length-1]),_.mealCOB>0&&(be>0||Fe>0)){for(le.forEach((function(e,a,r){r[a]=o(Math.min(401,Math.max(39,e)))})),Ve=le.length-1;Ve>12&&le[Ve-1]===le[Ve];Ve--)le.pop();y.predBGs.COB=le,Ue=o(le[le.length-1]),ne=Math.max(ne,o(le[le.length-1]))}if(be>0||Fe>0){if(ge){for(me.forEach((function(e,a,r){r[a]=o(Math.min(401,Math.max(39,e)))})),Ve=me.length-1;Ve>12&&me[Ve-1]===me[Ve];Ve--)me.pop();y.predBGs.UAM=me,je=o(me[me.length-1]),me[me.length-1]&&(ne=Math.max(ne,o(me[me.length-1])))}y.eventualBG=ne}console.error("UAM Impact:"+fe+"mg/dL per 5m; UAM Duration:"+Je+"hours"),Pe=Math.max(39,Pe),qe=Math.max(39,qe),Ee=Math.max(39,Ee),Ae=o(Pe);var Xe=_.mealCOB/_.carbs;Te=o(Ee<999&&qe<999?(1-Xe)*UAMpredBG+Xe*COBpredBG:qe<999?(Ze+COBpredBG)/2:Ee<999?(Ze+UAMpredBG)/2:Ze),Ne>Te&&(Te=Ne),We=o(We=pe||Fe>0?ge?Xe*ke+(1-Xe)*ze:ke:ge?ze:Le);var Ye=Ee;if(Ne<Q)Ye=(Ee+Ne)/2;else if(Ne<P){var ea=(Ne-Q)/(P-Q);Ye=(Ee+(Ee*ea+Ne*(1-ea)))/2}else Ne>Ee&&(Ye=(Ee+Ne)/2);if(Ye=o(Ye),_.carbs)if(!ge&&qe<999)Ae=o(Math.max(Pe,qe));else if(qe<999){var aa=Xe*qe+(1-Xe)*Ye;Ae=o(Math.max(Pe,qe,aa))}else Ae=ge?Ye:We;else ge&&(Ae=o(Math.max(Pe,Ye)));Ae=Math.min(Ae,Te),process.stderr.write("minPredBG: "+Ae+" minIOBPredBG: "+Pe+" minZTGuardBG: "+Ne),qe<999&&process.stderr.write(" minCOBPredBG: "+qe),Ee<999&&process.stderr.write(" minUAMPredBG: "+Ee),console.error(" avgPredBG:"+Te+" COB/Carbs:"+_.mealCOB+"/"+_.carbs),He>A&&(Ae=Math.min(Ae,He)),y.COB=_.mealCOB,y.IOB=r.iob,y.BGI=i(te,v),y.deviation=i(oe,v),y.ISF=i(X,v),y.CR=o(v.carb_ratio,2),y.target_bg=i(P,v),y.reason=n+", Standard, COB: "+y.COB+", Dev: "+y.deviation+", BGI: "+y.BGI+", CR: "+y.CR+", Target: "+y.target_bg+", minPredBG "+i(Ae,v)+", minGuardBG "+i(We,v)+", IOBpredBG "+i(De,v),Ue>0&&(y.reason+=", COBpredBG "+i(Ue,v)),je>0&&(y.reason+=", UAMpredBG "+i(je,v)),y.reason+="; ";var ra=ie;ra<40&&(ra=Math.min(We,ra));var ta,oa=Q-ra,ia=240,na=240;if(_.mealCOB>0&&(be>0||Fe>0)){for(Ve=0;Ve<le.length;Ve++)if(le[Ve]<q){ia=5*Ve;break}for(Ve=0;Ve<le.length;Ve++)if(le[Ve]<Q){na=5*Ve;break}}else{for(Ve=0;Ve<de.length;Ve++)if(de[Ve]<q){ia=5*Ve;break}for(Ve=0;Ve<de.length;Ve++)if(de[Ve]<Q){na=5*Ve;break}}ce&&We<Q&&(console.error("minGuardBG "+i(We,v)+" projected below "+i(Q,v)+" - disabling SMB"),ce=!1),void 0===v.maxDelta_bg_threshold&&(ta=.2),void 0!==v.maxDelta_bg_threshold&&(ta=Math.min(v.maxDelta_bg_threshold,.3)),j>ta*A&&(console.error("maxDelta "+i(j,v)+" > "+100*ta+"% of BG "+i(A,v)+" - disabling SMB"),y.reason+="maxDelta "+i(j,v)+" > "+100*ta+"% of BG "+i(A,v)+": SMB disabled; ",ce=!1),console.error("BG projected to remain above "+i(q,v)+" for "+ia+"minutes"),(na<240||ia<60)&&console.error("BG projected to remain above "+i(Q,v)+" for "+na+"minutes");var sa=na,la=v.current_basal*X*sa/60,da=Math.max(0,_.mealCOB-.25*_.carbs),ma=(oa-la)/csf-da;if(la=o(la),ma=o(ma),console.error("naive_eventualBG:"+ie+" bgUndershoot:"+oa+" zeroTempDuration:"+sa+" zeroTempEffect:"+la+" carbsReq:"+ma),ma>=v.carbsReqThreshold&&na<=45&&(y.carbsReq=ma,y.reason+=ma+" add'l carbs req w/in "+na+"m; "),A<Q&&r.iob<20*-v.current_basal/60&&D>0&&D>se)y.reason+="IOB "+r.iob+" < "+o(20*-v.current_basal/60,2),y.reason+=" and minDelta "+i(D,v)+" > expectedDelta "+i(se,v)+"; ";else if(A<Q||We<Q){y.reason+="minGuardBG "+i(We,v)+"<"+i(Q,v);var ua=(oa=P-We)/X,ca=o(60*ua/v.current_basal);return ca=30*o(ca/30),ca=Math.min(120,Math.max(30,ca)),B.setTempBasal(0,ca,v,y,a)}if(v.skip_neutral_temps&&y.deliverAt.getMinutes()>=55)return y.reason+="; Canceling temp at "+y.deliverAt.getMinutes()+"m past the hour. ",B.setTempBasal(0,0,v,y,a);if(ne<q){if(y.reason+="Eventual BG "+i(ne,v)+" < "+i(q,v),D>se&&D>0&&!ma)return ie<40?(y.reason+=", naive_eventualBG < 40. ",B.setTempBasal(0,30,v,y,a)):(e.delta>D?y.reason+=", but Delta "+i(w,v)+" > expectedDelta "+i(se,v):y.reason+=", but Min. Delta "+D.toFixed(2)+" > Exp. Delta "+i(se,v),a.duration>15&&t(F,v)===t(a.rate,v)?(y.reason+=", temp "+a.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,v,y,a)));var ga=2*Math.min(0,(ne-P)/X);ga=o(ga,2);var ba=Math.min(0,(ie-P)/X);if(ba=o(ba,2),D<0&&D>se)ga=o(ga*(D/se),2);var pa=F+2*ga;pa=t(pa,v);var fa=a.duration*(a.rate-F)/60;if(fa<Math.min(ga,ba)-.3*F)return y.reason+=", "+a.duration+"m@"+a.rate.toFixed(2)+" is a lot less than needed. ",B.setTempBasal(pa,30,v,y,a);if(void 0!==a.rate&&a.duration>5&&pa>=.8*a.rate)return y.reason+=", temp "+a.rate+" ~< req "+pa+"U/hr. ",y;if(pa<=0){if((ca=o(60*(ua=(oa=P-ie)/X)/v.current_basal))<0?ca=0:(ca=30*o(ca/30),ca=Math.min(120,Math.max(0,ca))),ca>0)return y.reason+=", setting "+ca+"m zero temp. ",B.setTempBasal(pa,ca,v,y,a)}else y.reason+=", setting "+pa+"U/hr. ";return B.setTempBasal(pa,30,v,y,a)}if(D<se&&(!M||!ce))return e.delta<D?y.reason+="Eventual BG "+i(ne,v)+" > "+i(q,v)+" but Delta "+i(w,v)+" < Exp. Delta "+i(se,v):y.reason+="Eventual BG "+i(ne,v)+" > "+i(q,v)+" but Min. Delta "+D.toFixed(2)+" < Exp. Delta "+i(se,v),a.duration>15&&t(F,v)===t(a.rate,v)?(y.reason+=", temp "+a.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,v,y,a));if(Math.min(ne,Ae)<E&&(!M||!ce))return y.reason+=i(ne,v)+"-"+i(Ae,v)+" in range: no temp required",a.duration>15&&t(F,v)===t(a.rate,v)?(y.reason+=", temp "+a.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,v,y,a));if(ne>=E&&(y.reason+="Eventual BG "+i(ne,v)+" >= "+i(E,v)+", "),r.iob>W)return y.reason+="IOB "+o(r.iob,2)+" > max_iob "+W,a.duration>15&&t(F,v)===t(a.rate,v)?(y.reason+=", temp "+a.rate+" ~ req "+F+"U/hr. ",y):(y.reason+="; setting current basal of "+F+" as temp. ",B.setTempBasal(F,30,v,y,a));(ga=o((Math.min(Ae,ne)-P)/X,2))>W-r.iob&&(y.reason+="max_iob "+W+", ",ga=W-r.iob),pa=t(pa=F+2*ga,v),ga=o(ga,3),y.insulinReq=ga;var va=o((new Date(G).getTime()-r.lastBolusTime)/6e4,1);if(M&&ce&&A>Q){var ha=o(_.mealCOB/v.carb_ratio,3);if(v.use_autoisf)_a=v.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var _a=1}if(_a>1&&console.error("SMB max range extended from default by factor "+_a),void 0===v.maxSMBBasalMinutes){var Ba=o(_a*v.current_basal*30/60,1);console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")}else r.iob>ha&&r.iob>0?(console.error("IOB",r.iob,"> COB",_.mealCOB+"; mealInsulinReq =",ha),v.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",v.maxUAMSMBBasalMinutes,"profile.current_basal:",v.current_basal),Ba=o(_a*v.current_basal*v.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),Ba=o(30*v.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",v.maxSMBBasalMinutes,"profile.current_basal:",v.current_basal),Ba=o(_a*v.current_basal*v.maxSMBBasalMinutes/60,1));var Ma=v.bolus_increment,xa=1/Ma;if(v.use_autoisf){var Sa=f(v,A,P);"SMB Delivery Ratio: "+o(Sa,2)+", "}else console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Sa=.5;Sa>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Sa,2));var ya=Math.min(ga*Sa,Ba);ya=Math.floor(ya*xa)/xa,ca=o(60*(ua=(P-(ie+Pe)/2)/X)/v.current_basal),ga>0&&ya<Ma&&(ca=0);var Ca=0;ca<=0?ca=0:ca>=30?(ca=30*o(ca/30),ca=Math.min(60,Math.max(0,ca))):(Ca=o(F*ca/30,2),ca=30),y.reason+=" insulinReq "+ga,ya>=Ba&&(y.reason+="; maxBolus "+Ba),ca>0&&(y.reason+="; setting "+ca+"m low temp of "+Ca+"U/h"),y.reason+=". ";var Ia=3;v.SMBInterval&&(Ia=Math.min(10,Math.max(1,v.SMBInterval)));var Fa=o(Ia-va,0),Ga=o(60*(Ia-va),0)%60;if(console.error("naive_eventualBG",ie+",",ca+"m "+Ca+"U/h temp needed; last bolus",va+"m ago; maxBolus: "+Ba),va>Ia?ya>0&&(y.units=ya,y.reason+="Microbolusing "+ya+"U. "):y.reason+="Waiting "+Fa+"m "+Ga+"s to microbolus again. ",ca>0)return y.rate=Ca,y.duration=ca,y}var wa=B.getMaxSafeBasal(v);return pa>wa&&(y.reason+="adj. req. rate: "+pa+" to maxSafeBasal: "+wa+", ",pa=t(wa,v)),(fa=a.duration*(a.rate-F)/60)>=2*ga?(y.reason+=a.duration+"m@"+a.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+pa+"U/hr. ",B.setTempBasal(pa,30,v,y,a)):void 0===a.duration||0===a.duration?(y.reason+="no temp, setting "+pa+"U/hr. ",B.setTempBasal(pa,30,v,y,a)):a.duration>5&&t(pa,v)<=t(a.rate,v)?(y.reason+="temp "+a.rate+" >~ req "+pa+"U/hr. ",y):(y.reason+="temp "+a.rate+"<"+pa+"U/hr. ",B.setTempBasal(pa,30,v,y,a))}},6880:(e,a,r)=>{var t=r(6654);e.exports=function(e,a){var r=20;void 0!==a&&"string"==typeof a.model&&(t(a.model,"54")||t(a.model,"23"))&&(r=40);return e<1?Math.round(e*r)/r:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,a,r)=>{var t=r(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,a){for(var r=-1,t=null==e?0:e.length,o=Array(t);++r<t;)o[r]=a(e[r],r,e);return o}},9750:e=>{e.exports=function(e,a,r){return e==e&&(void 0!==r&&(e=e<=r?e:r),void 0!==a&&(e=e>=a?e:a)),e}},4239:(e,a,r)=>{var t=r(2705),o=r(9607),i=r(2333),n=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":n&&n in Object(e)?o(e):i(e)}},531:(e,a,r)=>{var t=r(2705),o=r(9932),i=r(1469),n=r(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(a){if("string"==typeof a)return a;if(i(a))return o(a,e)+"";if(n(a))return l?l.call(a):"";var r=a+"";return"0"==r&&1/a==-Infinity?"-0":r}},7561:(e,a,r)=>{var t=r(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,a,r)=>{var t="object"==typeof r.g&&r.g&&r.g.Object===Object&&r.g;e.exports=t},9607:(e,a,r)=>{var t=r(2705),o=Object.prototype,i=o.hasOwnProperty,n=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var a=i.call(e,s),r=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=n.call(e);return t&&(a?e[s]=r:delete e[s]),o}},2333:e=>{var a=Object.prototype.toString;e.exports=function(e){return a.call(e)}},5639:(e,a,r)=>{var t=r(1957),o="object"==typeof self&&self&&self.Object===Object&&self,i=t||o||Function("return this")();e.exports=i},7990:e=>{var a=/\s/;e.exports=function(e){for(var r=e.length;r--&&a.test(e.charAt(r)););return r}},6654:(e,a,r)=>{var t=r(9750),o=r(531),i=r(554),n=r(9833);e.exports=function(e,a,r){e=n(e),a=o(a);var s=e.length,l=r=void 0===r?s:t(i(r),0,s);return(r-=a.length)>=0&&e.slice(r,l)==a}},1469:e=>{var a=Array.isArray;e.exports=a},3218:e=>{e.exports=function(e){var a=typeof e;return null!=e&&("object"==a||"function"==a)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,a,r)=>{var t=r(4239),o=r(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,a,r)=>{var t=r(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,a,r)=>{var t=r(8601);e.exports=function(e){var a=t(e),r=a%1;return a==a?r?a-r:a:0}},4841:(e,a,r)=>{var t=r(7561),o=r(3218),i=r(3448),n=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(i(e))return NaN;if(o(e)){var a="function"==typeof e.valueOf?e.valueOf():e;e=o(a)?a+"":a}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var r=s.test(e);return r||l.test(e)?d(e.slice(2),r?2:8):n.test(e)?NaN:+e}},9833:(e,a,r)=>{var t=r(531);e.exports=function(e){return null==e?"":t(e)}}},a={};function r(t){var o=a[t];if(void 0!==o)return o.exports;var i=a[t]={exports:{}};return e[t](i,i.exports,r),i.exports}r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=r(5546);freeaps_determineBasal=t})();